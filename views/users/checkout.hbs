{{>usernav}}
<div class="bg0 p-t-75 p-b-85">
    <div class="container">
        <div class="row">
            {{!-- <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl"> --}}
                    <section class="checkout_area section_gap">
                        <div class="container">
                            <div class="row">
                                <div class="page-content">
                                    <div class="checkout">
                                        <div class="container">
                                            <div class="checkout-discount">
                                                <div class="billing_details">
                                                    <div class="row">

                                                        <div class="col-lg-8">
                                                            <h3>Delivery Address</h3><br>


                                                            <form id='couponCode'>
                                                                <div class="flex-w flex-sb-m bor10 p-t-18 p-b-15 p-lr-40 p-lr-15-sm ">
                                                                <input type="text" name='couponcode'
                                                                    class="form-control stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" required
                                                                    id="checkout-discount-input" placeholder="Coupon Code">
                                                                <input type="text" name="total" class="form-control"
                                                                    value='{{total}}' hidden>
                                                               
                                                                <button type="submit" class="btn btn-secondary flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5">Apply
                                                                    Coupon</button>
                                                                <!-- Button trigger modal -->
                                                                <button type="button" class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10"
                                                                    data-toggle="modal"
                                                                    data-target="#exampleModalCenter">
                                                                    Show Coupons
                                                                </button>
                                                                 <label for="checkout-discount-input"
                                                                    class="text-truncate">Have a coupon? <span>Click
                                                                        here to enter your
                                                                        code</span></label>
                                                                 </div>

                                                                  

                                                                <!-- Modal -->
                                                                <div class="modal fade" id="exampleModalCenter"
                                                                    tabindex="-1" role="dialog"
                                                                    aria-labelledby="exampleModalCenterTitle"
                                                                    aria-hidden="true">
                                                                    <div class="modal-dialog modal-dialog-centered"
                                                                        role="document" >
                                                                        <div class="modal-content" style="background: transparent;">
                                                                            {{!-- <div class="modal-header">
                                                                                <h5 class="modal-title"
                                                                                    id="exampleModalLongTitle">Available
                                                                                    Coupons</h5>

                                                                                </button>
                                                                            </div> --}}
                                                                            <div class="modal-body">
                                                                                {{#each coupons}}
                                                                                <div class="card mb-3"
                                                                                    style="width: 570px;">
                                                                                    <div class="row g-0">
                                                                                        <div class="col-md-4">
                                                                                            <img src="/product-images/{{this.image.[0]}}"
                                                                                                style="width: 200px; height: 255px;"
                                                                                                alt="IMG">
                                                                                        </div>
                                                                                        <div class="col-md-8">
                                                                                            <div
                                                                                                class="card-body bg-light" style="height: 255px;">
                                                                                                <h2 class="card-title">
                                                                                                    {{this.description}}
                                                                                                </h2>
                                                                                                <h4 class="card-text">Flat{{this.percentage}}%off</h4>
                                                                                                <p class="card-text"> Minimum Amount:₹{{this.miniamt}}</p>
                                                                                                <p class="card-text">Maximum Amount:₹{{this.maxamt}}</p>
                                                                                                <br>
                                                                                                <p class="card-text">Coupon Code: <spanid="{{this._id}}">{{this.code}}</span>
                                                                                                    &nbsp;
                                                                                                <span class=" btn btn-primary" id="cpnBtn" onclick="copy('{{this.code}}')"> <i class="fa fa-clipboard"></i></p><br>
                                                                                                <p class="card-text">
                                                                                                    <small class="text-muted">ExpiryDate:{{this.date}}</small>
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                {{/each}}
                                                                            </div>
                                                                            {{!-- <div class="modal-footer">
                                                                                <button type="button"
                                                                                    class="btn btn-secondary"
                                                                                    data-dismiss="modal">Close</button>
                                                                                <button type="button"
                                                                                    class="btn btn-primary">Save
                                                                                    changes</button>
                                                                            </div> --}}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                            <br>
                                                            <a href="/add-address" class="btn btn-primary">Add New
                                                                Address</a>
                                                            <br>
                                                            &nbsp;
                                                            <form class="row contact_form" id="checkout-form">
                                                                <input type="text" name="userid" value="{{user._id}}"
                                                                    hidden>
                                                                <div class="form-check">
                                                                    {{#each address}}
                                                                    <input class="form-check-input" type="radio"
                                                                        name="address" id="f-option5"
                                                                        value="{{this._id}}" checked />
                                                                    <div class="card bg-light" style="width: 600px;">
                                                                        <div class="card-body">
                                                                            <h5 class="card-title ">
                                                                                <b>{{this.address.name}}</b> </h5>
                                                                            <p class="card-text">
                                                                                {{this.address.address}}
                                                                                <br>{{this.address.city}}
                                                                                <br>{{this.address.state}} <br>
                                                                                {{this.address.pincode}} <br> +91
                                                                                {{this.address.mobile}} <br>
                                                                                {{this.address.email}} <br></p> <br>
                                                                            <a href="/edit-address?address={{this._id}}"
                                                                                class="btn btn-outline-success">Edit</a>&nbsp;&nbsp;&nbsp;
                                                                            <a href="/delete-address?address={{this._id}}"
                                                                                class="btn btn-outline-danger">Delete</a>
                                                                        </div>
                                                                    </div>
                                                                    </label>&nbsp;
                                                                    {{/each}}
                                                                </div>

                                                        </div>
                                                        
                                                        <div class="col-lg-4 bg-light card w-50">

                                                            <div class=" p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                                                                
                                                                <h4 class="mtext-109 cl2 p-b-30">
                                                                    Your Orders
                                                                </h4>
                                                                {{#each product}}
                                                                <div class="flex-w flex-t  p-b-13">
                                                                    <p style="font-size: 14px;">
                                                                            {{this.product.name}} X 
                                                                     
                                                                             {{this.quantity}}:</p> &nbsp;
                                                                       
                                                                            <b> ₹ {{this.product.offerprice}}</b>
                                                                       
                                                                </div>
                                                                {{/each}}
                                                                <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                                                                    <div class="w-full-ssm">
                                                                        <span class="stext-110 cl2">
                                                                            Payment Method:
                                                                        </span>
                                                                    </div>

                                                                    <div class=" p-r-18 p-r-0-sm w-full-ssm">
                                                                        
                                                                        
                                                                        <div class="p-t-15">
                                                                            &nbsp;
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="radio" name="payment" id="f-option5" value="COD" />
                                                                                <label class="form-check-label" for="f-option5">COD
                                                                                </label>
                                                                            </div>
                                                                            &nbsp;
                                                                            &nbsp;
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="radio"
                                                                                    name="payment" id="f-option5"
                                                                                    value="Razor Pay" />
                                                                                <label class="form-check-label"
                                                                                    for="f-option5">Razor Pay
                                                                                </label>
                                                                            </div>

                                                                            &nbsp;
                                                                            &nbsp;
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="radio"
                                                                                    name="payment" id="f-option5"
                                                                                    value="Paypal" />
                                                                                <label class="form-check-label"
                                                                                    for="f-option5">Paypal
                                                                                </label>
                                                                            </div>

                                                                            &nbsp;
                                                                            &nbsp;
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="radio"
                                                                                    name="payment" id="f-option5"
                                                                                    value="Wallet" />
                                                                                <label class="form-check-label"
                                                                                    for="f-option5">Wallet
                                                                                </label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="flex-w flex-t p-t-27 p-b-13">
                                                                    <div class="size-208">
                                                                        <span class="stext-110 cl2">
                                                                            Subtotal:
                                                                        </span>
                                                                    </div>

                                                                    <div class="size-209">₹
                                                                        <span class="mtext-110 cl2">
                                                                             {{total}}
                                                                        </span>
                                                                    </div>
                                                                </div>

                                                                <div class="flex-w flex-t p-b-13">
                                                                    <div class="size-208">
                                                                        <span class="stext-110 cl2">
                                                                            Discount:
                                                                        </span>
                                                                    </div>

                                                                    <div class="size-209 ">₹
                                                                        <span id="subTotalValue" class="mtext-110 cl2">
                                                                            
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div class="bor12">

                                                                </div>

                                                                <div class="flex-w flex-t p-t-27 p-b-33 ">
                                                                    <div class="size-208 ">
                                                                        <span class="mtext-101 cl2">
                                                                            Total:
                                                                        </span>
                                                                    </div>

                                                                    <div class="size-209 p-t-1 ">₹
                                                                        <span id="finalAmount" class="mtext-110 cl2">
                                                                             {{total}}
                                                                        </span>
                                                                    </div>
                                                                </div>

                                                                <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                                                                    Proceed to Checkout
                                                                </button>
                                                            </div>
                                                        </div>

                                                            <div class="form-check">

                                                                <input type="text" id="sendfinalAmount"
                                                                    name="finalamoount" hidden>
                                                                <input type="text" id="sendSubTotal" name="subtotal"
                                                                    hidden>
                                                                <input type="text" id="sendCouponId" name="couponid"
                                                                    hidden>
                                                            </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>
{{>userfooter}}
{{>userjs}}


<script>
    function copy(code) {
        var copyText = code;
        // Copy the text inside the text field
        navigator.clipboard.writeText(copyText);
    }
</script>

<script>
    function copyToClipboard(element) {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val($(element).text()).select();
        document.execCommand("copy");
        $temp.remove();
    }
</script>
<script>

    $("#checkout-form").submit((e) => {
        e.preventDefault()
        $.ajax({
            url: "/checkout",
            method: "post",
            data: $("#checkout-form").serialize(),
            success: (response) => {
                if (response.COD_success) {
                    location.href = "/order-success"
                } else {
                    razorpayPayment(response)
                }

            }
        })
    })
    function razorpayPayment(order) {

        var options = {
            "key": "rzp_test_mGCkjnYzmndh3j", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "ASHLEY TRENDS",
            "description": "Test Transaction",
            "image": "/users/images/Ashley_trends.png",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    
        "handler": function(response) {


            verifyPayment(response, order)
        },
        "prefill": {
            "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                    "contact": "9999999999"
        },
        "notes": {
            "address": "Razorpay Corporate Office"
        },
        "theme": {
            "color": "#3399cc"
        }
    };
    var rzp1 = new Razorpay(options);

    rzp1.open();
 

    }
    function verifyPayment(payment, order) {
        $.ajax({
            url: "/verifyPayment",
            data: {
                payment,
                order
            },
            method: 'post',
            success: (response) => {

                location.href = "/order-success"

            }
        })
    }
</script>

<script>
    $("#address").submit((e) => {
        e.preventDefault()
        $.ajax({
            url: "/addAddress",
            method: "post",
            data: $("#address").serialize(),
            success: (response) => {
                //alert("haoooooooooo")
                location.reload()
            }
        })
    })


</script>

<script>
    $("#couponCode").submit((e) => {
        e.preventDefault()
        alert("called")
        $.ajax({

            url: '/couponCheck',
            method: 'post',
            data: $('#couponCode').serialize(),
            success: (response) => {
                alert('success')
                if (response.couponVerified) {
                    document.getElementById("subTotalValue").innerHTML = response.subtotal;
                    document.getElementById("finalAmount").innerHTML = response.amount;
                    //document.getElementById("errMsg").innerHTML = "";
                    //---send values-- to checkout ---=--/
                    document.getElementById("sendSubTotal").value = response.subtotal;
                    document.getElementById("sendfinalAmount").value = response.amount;
                    document.getElementById("sendCouponId").value = response._id;
                } else {
                    alert('hiiiielse')
                    if (response.dateChecked) {
                        alert('date expired')
                        document.getElementById("errMsg").innerHTML = response.dateInvalidMessage;
                    } else if (response.minChecked) {
                        alert('minimum amount')
                        document.getElementById("errMsg").innerHTML = response.maxAmountMsg;
                    } else if (response.usedCoupon) {
                        alert('used Coupon')
                        document.getElementById("errMsg").innerHTML = response.usedCouponMsg;
                    }
                    else {
                        alert("coupon invalid")
                        document.getElementById("errMsg").innerHTML = response.invalidMessage;
                    }
                }
            }
        })
    })
</script>

</body>

</html>